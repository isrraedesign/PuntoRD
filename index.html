<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PuntoRD - Todos los puntos por provincia (en tiempo real)</title>

  <!-- Leaflet core -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- Leaflet.markercluster CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

  <style>
    body { margin:0; font-family: Arial, Helvetica, sans-serif; background:#f5f7f9; }
    header{ background:#00796b; color:white; padding:14px; text-align:center; font-size:18px; font-weight:700 }
    #controls{ display:flex; gap:8px; align-items:center; padding:10px; justify-content:center; background:#fff; box-shadow:0 1px 4px rgba(0,0,0,0.08) }
    select, button { padding:8px 10px; border-radius:6px; border:1px solid #cfd8dc; font-size:14px }
    #map { height:78vh; width:100%; }
    footer{ text-align:center; padding:10px; background:#00796b; color:#fff; font-size:13px }
    .legend { position: absolute; left:10px; bottom:70px; background:white; padding:8px; border-radius:6px; box-shadow:0 2px 6px rgba(0,0,0,0.12) }
    .loading { position: absolute; right:10px; top:10px; background:rgba(255,255,255,0.9); padding:6px 10px; border-radius:6px; box-shadow:0 1px 4px rgba(0,0,0,0.12) }
  </style>
</head>
<body>
  <header>üåé PuntoRD ‚Äî Puntos (playas, r√≠os, restaurantes, hoteles, tiendas, atracciones) por provincia</header>

  <div id="controls">
    <label>Provincia:
      <select id="provincia">
        <option value="todas">Todas</option>
        <!-- Lista completa (31 provincias + Distrito Nacional) -->
        <option>Azua</option><option>Baoruco</option><option>Barahona</option><option>Dajab√≥n</option>
        <option>Distrito Nacional</option><option>Duarte</option><option>El√≠as Pi√±a</option><option>El Seibo</option>
        <option>Espaillat</option><option>Hato Mayor</option><option>Hermanas Mirabal</option><option>Independencia</option>
        <option>La Altagracia</option><option>La Romana</option><option>La Vega</option><option>Mar√≠a Trinidad S√°nchez</option>
        <option>Monse√±or Nouel</option><option>Monte Cristi</option><option>Monte Plata</option><option>Pedernales</option>
        <option>Peravia</option><option>Puerto Plata</option><option>Hermanas Mirabal</option><option>Saman√°</option>
        <option>S√°nchez Ram√≠rez</option><option>San Crist√≥bal</option><option>San Jos√© de Ocoa</option><option>San Juan</option>
        <option>San Pedro de Macor√≠s</option><option>Santo Domingo</option><option>Santiago</option><option>Santiago Rodr√≠guez</option>
        <option>Valverde</option>
      </select>
    </label>

    <button id="cargar">Cargar puntos (Overpass)</button>
    <label><input id="soloDest" type="checkbox"> Solo destacados</label>
    <button id="reset">Limpiar</button>
  </div>

  <div id="map"></div>

  <div class="legend" id="legend">
    <div>üîµ Playa / üèû R√≠o / üçΩ Restaurante / üè® Hotel / üõç Tienda / üìç Atracci√≥n / ‚ö†Ô∏è Restricci√≥n</div>
  </div>

  <div class="loading" id="loading" style="display:none">Cargando datos‚Ä¶</div>

  <footer>¬© 2025 PuntoRD ‚Äî Datos: OpenStreetMap / Overpass API</footer>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <script>
  // --- Inicializaci√≥n b√°sica ---
  const map = L.map('map').setView([18.7357, -70.1627], 8);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap contributors'
  }).addTo(map);

  // Cluster layer para muchos marcadores
  const markersCluster = L.markerClusterGroup();
  map.addLayer(markersCluster);

  const loadingEl = document.getElementById('loading');
  function setLoading(on){ loadingEl.style.display = on ? 'block' : 'none'; }

  // Iconos simples por tipo (usamos emoji en popup y color del circleMarker)
  const tipoColor = { 'beach':'#1976d2', 'river':'#00695c', 'restaurant':'#ef6c00', 'hotel':'#6a1b9a', 'shop':'#2e7d32', 'attraction':'#0288d1', 'restriction':'#d32f2f', 'other':'#546e7a' };

  // Lista manual de puntos destacados (los m√°s visitados) por provincia ‚Äî ejemplos que puedes ampliar
  // He incluido los principales por provincia (no es exhaustivo de comercios; Overpass trae TODO)
  const destacados = {
    "Santo Domingo": [
      {nombre:"Zona Colonial", tipo:"attraction", coords:[18.47,-69.89]},
      {nombre:"Malec√≥n", tipo:"attraction", coords:[18.46,-69.90]}
    ],
    "La Romana":[
      {nombre:"Altos de Chav√≥n", tipo:"attraction", coords:[18.42,-68.90]},
      {nombre:"Playa Bayahibe", tipo:"beach", coords:[18.36,-68.83]}
    ],
    "Puerto Plata":[
      {nombre:"Telef√©rico", tipo:"attraction", coords:[19.77,-70.68]},
      {nombre:"Playa Dorada", tipo:"beach", coords:[19.76,-70.65]}
    ],
    "Saman√°":[
      {nombre:"Cascada El Lim√≥n", tipo:"river", coords:[19.29,-69.40]},
      {nombre:"Playa Rinc√≥n", tipo:"beach", coords:[19.25,-69.32]}
    ],
    "Barahona":[
      {nombre:"Bah√≠a de las √Åguilas", tipo:"beach", coords:[17.82,-71.55]}
    ],
    "La Vega":[
      {nombre:"Salto de Jimenoa", tipo:"river", coords:[19.12,-70.55]}
    ],
    "Santiago":[
      {nombre:"Monumento a los H√©roes", tipo:"attraction", coords:[19.45,-70.69]}
    ],
    "Pedernales":[
      {nombre:"Parque Nacional Jaragua", tipo:"attraction", coords:[17.84,-71.48]}
    ]
    // Puedes a√±adir manualmente m√°s destacados por provincia aqu√≠
  };

  // Funci√≥n que construye la consulta Overpass para una provincia y categor√≠a amplia
  function buildOverpassQuery(areaName) {
    // buscamos en area por nombre (puede devolver m√°s de un match; Overpass resolver√°)
    // traemos nodos/ways/relations con tags √∫tiles: amenity, tourism, shop, leisure, natural=water, waterway=river, beach
    const categories = [
      'amenity~"restaurant|cafe|bar|fast_food|pub|market|hospital|clinic|pharmacy"',
      'tourism~"hotel|hostel|museum|attraction|viewpoint|zoo|theme_park"',
      'shop',
      'leisure~"park|stadium|garden|swimming_pool"',
      'natural~"water|beach"',
      'waterway~"river|stream"'
    ];
    const union = categories.map(c => `node[${c}](area.searchArea);way[${c}](area.searchArea);relation[${c}](area.searchArea);`).join('\n');
    const q = `[out:json][timeout:90];
      area["name"="${areaName}"]->.searchArea;
      (
        ${union}
      );
      out center tags;`;
    return q;
  }

  // Llama Overpass y devuelve array de puntos normalizados
  async function fetchOverpass(areaName){
    setLoading(true);
    try{
      const query = buildOverpassQuery(areaName);
      const resp = await fetch('https://overpass-api.de/api/interpreter', { method:'POST', body: query });
      if(!resp.ok) throw new Error('Error Overpass: ' + resp.status);
      const data = await resp.json();
      // Normalizar elementos
      const items = (data.elements||[]).map(e => {
        const lat = e.lat || (e.center && e.center.lat);
        const lon = e.lon || (e.center && e.center.lon);
        const tags = e.tags || {};
        const name = tags.name || tags['alt_name'] || null;
        // determinar tipo aproximado
        let tipo = 'other';
        if(tags.tourism) tipo = tags.tourism;
        else if(tags.amenity) tipo = tags.amenity;
        else if(tags.shop) tipo = 'shop';
        else if(tags.natural === 'water') tipo = 'river';
        else if(tags.natural === 'beach') tipo = 'beach';
        else if(tags.waterway) tipo = 'river';
        return { id: e.id, lat, lon, name, tags, tipo };
      }).filter(i => i.lat && i.lon);
      return items;
    } finally { setLoading(false); }
  }

  // Mostrar marcadores (acepta array de items Overpass + destacados manuales)
  function renderItems(items, provincia, soloDest){
    markersCluster.clearLayers();
    // primero mostrar destacados manuales
    const manual = destacados[provincia] || [];
    if(!soloDest){
      manual.forEach(d => {
        const m = L.circleMarker(d.coords, { radius:12, color:'gold', fillColor:'gold', fillOpacity:0.95 }).bindPopup(`<b>‚≠ê ${d.nombre}</b><br>${d.tipo}`);
        markersCluster.addLayer(m);
      });
    } else {
      // si soloDest verdadero, mostramos solo manuales (si existen)
      manual.forEach(d => {
        const m = L.circleMarker(d.coords, { radius:12, color:'gold', fillColor:'gold', fillOpacity:0.95 }).bindPopup(`<b>‚≠ê ${d.nombre}</b><br>${d.tipo}`);
        markersCluster.addLayer(m);
      });
    }

    if(!soloDest){
      // mapear items a estilo y a√±adir
      items.forEach(it => {
        const kind = determineKind(it);
        const color = tipoColor[kind] || tipoColor.other;
        const mk = L.circleMarker([it.lat,it.lon], { radius:5, color, fillColor: color, fillOpacity:0.9 })
          .bindPopup(`<b>${escapeHtml(it.name || '(sin nombre)')}</b><br>${kind}<br><small>${escapeHtml(firstTagSummary(it.tags))}</small>`);
        markersCluster.addLayer(mk);
      });
    }

    map.fitBounds(markersCluster.getBounds() || [[18.7357,-70.1627]]);
  }

  function determineKind(item){
    const t = (item.tipo || '').toLowerCase();
    if(t.includes('beach') || item.tags.natural === 'beach') return 'beach';
    if(t.includes('river') || item.tags.waterway) return 'river';
    if(t.includes('restaurant') || t.includes('cafe') || t.includes('bar') || t.includes('fast_food')) return 'restaurant';
    if(t.includes('hotel') || t.includes('hostel') || t.includes('motel')) return 'hotel';
    if(t.includes('shop')) return 'shop';
    if(t.includes('tourism') || t.includes('attraction') || t.includes('museum') || t.includes('viewpoint')) return 'attraction';
    return 'other';
  }

  function firstTagSummary(tags){
    // devuelve string compacto con tags importantes
    const keys = ['amenity','tourism','shop','leisure','natural','waterway'];
    return keys.map(k => tags[k] ? `${k}: ${tags[k]}` : null).filter(Boolean).slice(0,3).join(' | ');
  }

  function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  // Acci√≥n principal: cargar por provincia
  document.getElementById('cargar').addEventListener('click', async () => {
    const prov = document.getElementById('provincia').value;
    if(!prov || prov === 'todas'){
      alert('Selecciona una provincia espec√≠fica para cargar todos los POI (evita consultas muy grandes).');
      return;
    }
    const soloDest = document.getElementById('soloDest').checked;
    try{
      setLoading(true);
      // fetch Overpass para la provincia
      const items = await fetchOverpass(prov);
      // mostramos items + destacados manuales
      renderItems(items, prov, soloDest);
    } catch(err){
      alert('Error cargando datos: ' + err.message);
    } finally{
      setLoading(false);
    }
  });

  // Reset limpia marcadores
  document.getElementById('reset').addEventListener('click', () => {
    markersCluster.clearLayers();
    map.setView([18.7357, -70.1627], 8);
  });

  // Al seleccionar provincia, si hay destacados mostramos autom√°ticamente
  document.getElementById('provincia').addEventListener('change', (e) => {
    const prov = e.target.value;
    markersCluster.clearLayers();
    const manual = destacados[prov] || [];
    manual.forEach(d => {
      const m = L.circleMarker(d.coords, { radius:12, color:'gold', fillColor:'gold', fillOpacity:0.95 }).bindPopup(`<b>‚≠ê ${d.nombre}</b><br>${d.tipo}`);
      markersCluster.addLayer(m);
    });
    if(manual.length) map.fitBounds(markersCluster.getBounds());
  });

  // Inicial: mostrar algunos destacados de SRD
  (function init(){
    const initialProv = 'Santo Domingo';
    const manual = destacados[initialProv] || [];
    manual.forEach(d => {
      const m = L.circleMarker(d.coords, { radius:12, color:'gold', fillColor:'gold', fillOpacity:0.95 }).bindPopup(`<b>‚≠ê ${d.nombre}</b><br>${d.tipo}`);
      markersCluster.addLayer(m);
    });
    if(manual.length) map.fitBounds(markersCluster.getBounds());
  })();

  // Advertencias y recomendaciones:
  // - Overpass devuelve lo que hay en OpenStreetMap: cantidad y calidad dependen de contribuciones.
  // - Evita pulsar "Cargar puntos" repetidamente sobre la misma provincia en segundos (rate limits).
  // - Para producci√≥n: cachear resultados por provincia en servidor y usar tiles/servicio con SLA.
  // Fuentes: Overpass API docs / Overpass QL. :contentReference[oaicite:6]{index=6}
  </script>
</body>
</html>
