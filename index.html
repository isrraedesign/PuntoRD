<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PuntoRD ‚Äî Puerto Plata & Punta Cana</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <!-- Tu CSS -->
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header>
    <div class="brand">
      <h1>üå¥ PuntoRD</h1>
      <div class="subtitle">Tu gu√≠a interactiva de Puerto Plata & Punta Cana</div>
    </div>

    <div class="controls">
      <select id="languageSelect" aria-label="Idioma">
        <option value="es">Espa√±ol</option>
        <option value="en">English</option>
      </select>

      <select id="provinceSelect" aria-label="Provincia">
        <option value="">-- Seleccionar provincia --</option>
        <option value="puerto_plata">Puerto Plata</option>
        <option value="la_altagracia">Punta Cana (La Altagracia)</option>
      </select>

      <button id="loadBtn">Cargar</button>
      <button id="locateBtn">Mi ubicaci√≥n</button>
    </div>
  </header>

  <main id="main">
    <aside id="sidebar">
      <input id="search" placeholder="Buscar (nombre / tipo)" />
      <div id="list" class="list"></div>
    </aside>

    <div id="map"></div>
  </main>

  <footer>¬© 2025 PuntoRD ‚Äî Gu√≠a Tur√≠stica</footer>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
  // --- Config inicial ---
  const LANG = { current: 'es' };
  const markers = [];
  let map, clusterLayer;
  let userMarker = null;
  let watchId = null;
  let lugaresData = [];

  // Inicializar mapa (OpenStreetMap tiles, sin token)
  function initMap() {
    map = L.map('map').setView([19.78, -70.68], 10);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // opcional: grupo de marcadores (sin librer√≠a adicional usamos layerGroup)
    clusterLayer = L.layerGroup().addTo(map);
  }

  // Cargar JSON de lugares
  async function loadLugares() {
    try {
      const res = await fetch('lugares.json');
      lugaresData = await res.json();
      console.log('Lugares cargados', lugaresData.length);
    } catch (e) {
      alert('No se pudo cargar lugares.json: ' + e.message);
    }
  }

  // Filtrar por provincia y mostrar
  function mostrarProvincia(prov) {
    clusterLayer.clearLayers();
    document.getElementById('list').innerHTML = '';

    const lista = lugaresData.filter(p => p.provincia === prov);
    if(!lista.length) {
      document.getElementById('list').innerHTML = '<div class="meta">No hay puntos para esta provincia.</div>';
      return;
    }

    const bounds = [];
    lista.forEach((p, i) => {
      // elegir texto seg√∫n idioma
      const text = (p.trans && p.trans[LANG.current]) ? p.trans[LANG.current] : { name: p.nombre, desc: p.descripcion };
      const color = colorByType(p.tipo);

      const marker = L.circleMarker([p.lat, p.lon], {
        radius: p.highlight ? 9 : 6,
        color: '#fff',
        weight: 1,
        fillColor: color,
        fillOpacity: 0.95
      });

      const popupHtml = `
        <div style="min-width:220px">
          <strong>${escapeHtml(text.name)}</strong><br>
          <em>${p.tipo}</em><div style="margin-top:6px">${escapeHtml(text.desc)}</div>
          <div style="margin-top:8px;display:flex;gap:6px">
            <button onclick="getDirections(${p.lat},${p.lon})"> ${LANG.current==='es' ? 'C√≥mo llegar' : 'Get directions'} </button>
            <button onclick="zoomTo(${p.lat},${p.lon})">${LANG.current==='es' ? 'Ver' : 'Show'}</button>
          </div>
        </div>
      `;

      marker.bindPopup(popupHtml);
      marker.bindTooltip(text.name, {permanent:true, direction:'top', className:'mylabel', offset:[0,-12]});

      marker.addTo(clusterLayer);
      markers.push(marker);
      bounds.push([p.lat, p.lon]);

      // lista lateral
      const div = document.createElement('div');
      div.className = 'item';
      div.innerHTML = `<div class="title">${escapeHtml(text.name)}</div><div class="small">${escapeHtml(p.tipo)}</div>`;
      div.addEventListener('click', ()=>{ map.setView([p.lat,p.lon], 15); marker.openPopup(); });
      document.getElementById('list').appendChild(div);
    });

    if(bounds.length) map.fitBounds(bounds, {padding:[40,40], maxZoom:15});
  }

  // color por tipo simple
  function colorByType(type){
    type = (type||'').toLowerCase();
    if(type.includes('playa')||type.includes('beach')) return '#0288d1';
    if(type.includes('hotel')||type.includes('villa')||type.includes('resort')) return '#8e24aa';
    if(type.includes('restaurante')||type.includes('restaurant')||type.includes('bar')) return '#ff7043';
    if(type.includes('museo')||type.includes('hist√≥ric')) return '#f4c542';
    if(type.includes('parque')||type.includes('reserve')||type.includes('nature')) return '#2e7d32';
    return '#607d8b';
  }

  // escape para insertar texto seguro en HTML
  function escapeHtml(s){ return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

  // zoom a coordenada
  function zoomTo(lat,lon){ map.setView([lat,lon],15); }

  // abrir direcci√≥n en Google Maps (desde la ubicaci√≥n del usuario si permite)
  function getDirections(lat, lon){
    if(navigator.geolocation){
      navigator.geolocation.getCurrentPosition(pos=>{
        const origin = `${pos.coords.latitude},${pos.coords.longitude}`;
        const url = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${lat},${lon}`;
        window.open(url, '_blank');
      }, ()=> window.open(`https://www.google.com/maps?q=${lat},${lon}`, '_blank'));
    } else {
      window.open(`https://www.google.com/maps?q=${lat},${lon}`, '_blank');
    }
  }
  window.getDirections = getDirections;
  window.zoomTo = zoomTo;

  // Geolocalizaci√≥n en tiempo real (watchPosition)
  function toggleLocate(){
    if(watchId){
      navigator.geolocation.clearWatch(watchId);
      watchId = null;
      if(userMarker) map.removeLayer(userMarker);
      document.getElementById('locateBtn').textContent = LANG.current==='es' ? 'Mi ubicaci√≥n' : 'My location';
      return;
    }
    if(!navigator.geolocation){ alert('Geolocalizaci√≥n no disponible'); return; }
    watchId = navigator.geolocation.watchPosition(pos=>{
      const lat = pos.coords.latitude, lon = pos.coords.longitude;
      if(!userMarker){
        userMarker = L.circleMarker([lat,lon], {radius:8, fillColor:'#ff5252', color:'#fff', weight:1, fillOpacity:0.95}).addTo(map).bindPopup(LANG.current==='es' ? 'Est√°s aqu√≠' : 'You are here');
      } else { userMarker.setLatLng([lat,lon]); }
      document.getElementById('locateBtn').textContent = (LANG.current==='es' ? 'Detener ubicaci√≥n' : 'Stop location');
    }, err => { alert('Permite la ubicaci√≥n en tu navegador'); }, {enableHighAccuracy:true, maximumAge:30000, timeout:10000});
  }

  // Buscar en la lista cargada (filtro)
  function buscar(q){
    q = (q||'').toLowerCase();
    const items = Array.from(document.querySelectorAll('#list .item'));
    items.forEach(it => {
      const text = it.innerText.toLowerCase();
      it.style.display = text.includes(q) ? 'block' : 'none';
    });
  }

  // eventos UI
  document.addEventListener('DOMContentLoaded', async ()=>{
    initMap();
    await loadLugares();

    document.getElementById('loadBtn').addEventListener('click', ()=>{
      const prov = document.getElementById('provinceSelect').value;
      if(!prov){ alert('Selecciona una provincia'); return; }
      mostrarProvincia(prov);
    });

    document.getElementById('languageSelect').addEventListener('change', (e)=>{
      LANG.current = e.target.value;
      // recargar lista/markers con nuevo idioma si ya hubo carga
      const prov = document.getElementById('provinceSelect').value;
      if(prov) mostrarProvincia(prov);
      document.getElementById('locateBtn').textContent = LANG.current==='es' ? 'Mi ubicaci√≥n' : 'My location';
    });

    document.getElementById('locateBtn').addEventListener('click', toggleLocate);

    document.getElementById('search').addEventListener('input', (e)=> buscar(e.target.value) );
  });
  </script>
</body>
</html>
